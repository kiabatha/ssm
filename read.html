<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Story Reader</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Quicksand', sans-serif;
      background-color: #04A2B6;
    }

    @media (prefers-color-scheme: dark) {
      html, body {
        background-color: #333333;
        color: #FFF;
      }
    }

    .content {
      max-width: 800px;
      margin: 10px 15px 30px 15px;
      padding: 13px;
      background-color: #ffffff;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      text-align: center;
    }

    .image-container {
      position: relative;
      display: inline-block;
    }

    #storyImage {
      display: block;
      margin-top: 5px;
      margin-bottom: 0;
      width: 100%;
      max-width: 600px;
      height: auto;
      border-radius: 16px;
      object-fit: cover;
      position: relative;
      z-index: 1;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .favorite-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 28px;
      background-color: transparent;
      border: none;
      cursor: pointer;
      z-index: 2;
      transition: transform 0.2s ease;
      display: none;
    }

    .favorite-icon:hover {
      transform: scale(1.1);
    }

    .button-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 20px;
    }

    .action-button {
      min-width: 80px;
      padding: 6px 8px;
      font-size: 13px;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      max-width: 100px;
      flex: 1 1 auto;
    }

    .red-button {
      background-color: #E53935;
    }

    .round-button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      font-size: 16px;
      font-weight: bold;
      background-color: #2196F3;
      color: white;
      border: none;
      cursor: pointer;
    }

    #storyText {
      display: block;
      white-space: pre-wrap;
      text-align: justify;
      font-size: 14px;
      line-height: 1.4;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      background-color: white;
      border-radius: 12px;
      color: #000;
      box-shadow: none;
      padding: 12px;
    }

    #audioBar {
      display: none;
      margin: 10px auto 0;
      width: 100%;
      max-width: 600px;
      border-radius: 0;
      padding: 0;
      background-color: transparent;
    }

    #scrollSpeedContainer {
      display: none;              /* hidden by default */
      margin-top: 10px;
    }

    .scroll-speed-row {
      display: flex;               /* ‚úÖ side-by-side */
      justify-content: center;     /* center horizontally */
      align-items: center;         /* align vertically */
      gap: 10px;                   /* space between label and slider */
      font-size: 12px;             /* smaller label */
    }

    .scroll-speed-row label {
      font-weight: 600;
      color: #000;
    }

    #scrollSpeedSlider {
      width: 170px;
      height: 6px;
    }
  </style>
</head>
<body>
  <div class="content">
    <div class="image-container">
      <img id="storyImage" src="" alt="Story Illustration" />
      <button class="favorite-icon" onclick="toggleFavorite()">ü§ç</button>
    </div>

    <div class="button-row">
      <button class="action-button red-button" onclick="playAudio('man')">Man</button>
      <button class="round-button" onclick="adjustFontSize(-1)">‚àí</button>
      <button class="round-button" onclick="adjustFontSize(1)">+</button>
      <button class="action-button red-button" onclick="playAudio('woman')">Woman</button>
    </div>

    <audio id="audioBar" controls controlsList="nodownload"></audio>

    <div id="scrollSpeedContainer">
      <div class="scroll-speed-row">
        <label for="scrollSpeedSlider">Scroll Speed:</label>
        <input type="range" id="scrollSpeedSlider" min="10" max="200" value="60" />
      </div>
    </div>

    <div id="storyText"></div>
  </div>

<script>
  // Category to JSON file mapping
  const categoryJsonMap = {
    'moral': 'moral-stories.json',
    'adventure': 'adventure-stories.json',
    'fantasy': 'fantasy-stories.json',
    'educational': 'educational-stories.json',
    'bedtime': 'bedtime-stories.json'
    // Add more categories and their corresponding JSON files here
  };

  function toggleFavorite() {
    console.log("Favorite toggled");
  }

  function setupAudioListeners() {
    const audioElements = document.querySelectorAll('audio, video');
    audioElements.forEach(audio => {
      audio.addEventListener('play', () => {
        if (window.Android) window.Android.onAudioStateChange(true);
      });
      audio.addEventListener('pause', () => {
        if (window.Android) window.Android.onAudioStateChange(false);
      });
      audio.addEventListener('ended', () => {
        if (window.Android) window.Android.onAudioStateChange(false);
      });
    });
  }

  const observer = new MutationObserver(mutations => {
    mutations.forEach(mutation => {
      if (mutation.addedNodes.length) setupAudioListeners();
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    setupAudioListeners();
    observer.observe(document.body, { childList: true, subtree: true });
  });

  window.addEventListener('load', setupAudioListeners);

  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");
  const category = params.get("category"); // New parameter for category
  const mode = params.get("mode");

  let storyData;
  let scrollInterval;
  const audioBar = document.getElementById("audioBar");

  // ‚úÖ Start font size from actual CSS value
  let currentFontSize = parseInt(window.getComputedStyle(document.getElementById("storyText")).fontSize);

  // Function to determine which JSON file to load based on category
  function getJsonFileForCategory() {
    // If category is specified in URL, use the mapping
    if (category && categoryJsonMap[category]) {
      return categoryJsonMap[category];
    }
    
    // Fallback: try to determine category from the ID pattern or use default
    // You can modify this logic based on your ID naming convention
    if (id && id.includes('moral')) return 'moral-stories.json';
    if (id && id.includes('adventure')) return 'adventure-stories.json';
    if (id && id.includes('fantasy')) return 'fantasy-stories.json';
    if (id && id.includes('educational')) return 'educational-stories.json';
    if (id && id.includes('bedtime')) return 'bedtime-stories.json';
    
    // Default fallback
    return 'stories.json';
  }

  // Load the appropriate JSON file
  const jsonFileName = getJsonFileForCategory();
  const jsonUrl = `https://kiabatha.github.io/ssm/${jsonFileName}`;

  fetch(jsonUrl)
    .then(res => {
      if (!res.ok) {
        throw new Error(`Failed to load ${jsonFileName}`);
      }
      return res.json();
    })
    .then(data => {
      // Handle different JSON structures - array or object
      if (Array.isArray(data)) {
        // If JSON is an array, find story by ID
        storyData = data.find(story => story.id === id);
      } else {
        // If JSON is an object, get story by ID key
        storyData = data[id];
      }
      
      if (!storyData) throw new Error("Story not found");

      fetch(`https://kiabatha.github.io/ssm/${storyData.text}`)
        .then(res => {
          if (!res.ok) {
            throw new Error("Failed to load story text");
          }
          return res.text();
        })
        .then(text => {
          document.getElementById("storyText").innerText = text;
          document.getElementById("storyImage").src = `https://kiabatha.github.io/ssm/${storyData.image}`;
          if (mode === "manual") {
            document.getElementById("storyText").style.display = "block";
          }
        })
        .catch(err => {
          console.error("Error loading story text:", err);
          document.getElementById("storyText").innerText = "Failed to load story content.";
        });
    })
    .catch(err => {
      console.error("Error loading story data:", err);
      document.getElementById("storyText").innerText = "Failed to load story. Please check if the story exists.";
    });

  function startScrolling() {
    const speedSlider = document.getElementById("scrollSpeedSlider");
    let speed = parseInt(speedSlider.value);
    scrollInterval = setInterval(() => {
      document.getElementById("storyText").scrollBy(0, 1);
    }, speed);
    speedSlider.addEventListener("input", () => {
      clearInterval(scrollInterval);
      let newSpeed = parseInt(speedSlider.value);
      scrollInterval = setInterval(() => {
        document.getElementById("storyText").scrollBy(0, 1);
      }, newSpeed);
    });
  }

  function playAudio(gender) {
    if (!storyData) {
      console.error("Story data not loaded");
      return;
    }

    const audioPath = gender === "woman" ? storyData.audio_woman : storyData.audio_man;
    if (!audioPath) {
      console.error("Audio path not found for gender:", gender);
      return;
    }

    audioBar.src = `https://kiabatha.github.io/ssm/${audioPath}`;
    audioBar.style.display = "block";
    audioBar.volume = 1.0;

    // ‚úÖ Show scroll speed controls only when audio starts
    document.getElementById("scrollSpeedContainer").style.display = "block";

    document.getElementById("storyText").scrollTop = 0;
    clearInterval(scrollInterval);

    audioBar.oncanplaythrough = () => {
      document.getElementById("storyText").scrollTop = 0;
      clearInterval(scrollInterval);
      audioBar.play();
      document.getElementById("storyText").style.display = "block";
      setTimeout(() => {
        startScrolling();
      }, 6000);
    };

    audioBar.addEventListener("pause", () => clearInterval(scrollInterval));
    audioBar.addEventListener("ended", () => clearInterval(scrollInterval));
  }

  function adjustFontSize(change) {
    currentFontSize = Math.max(14, Math.min(28, currentFontSize + change));
    document.getElementById("storyText").style.fontSize = currentFontSize + "px";
  }

  document.addEventListener("visibilitychange", () => {
    if (document.hidden && !audioBar.paused) {
      audioBar.pause();
      clearInterval(scrollInterval);
    }
  });

  window.addEventListener("beforeunload", () => {
    audioBar.pause();
    clearInterval(scrollInterval);
  });
</script>
</body>
</html>
